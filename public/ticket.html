<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ticket Details - HelpDesk Mini</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <div class="site">
    <div class="card" style="max-width:900px;margin:auto">
      <div class="header" style="display:flex;justify-content:space-between;align-items:center">
        <h1>Ticket Details</h1>
        <button onclick="window.location.href='tickets.html'">Back to Tickets</button>
      </div>
      <div class="ticket-details" id="ticket"></div>
      <h2>Comments</h2>
      <div id="comments"></div>
      <form id="commentForm">
        <textarea id="commentText" placeholder="Add a comment..." required></textarea>
        <button type="submit">Add Comment</button>
      </form>
    </div>
  </div>
  <script>
  const API_BASE = '/api';
    const token = localStorage.getItem('token');
    const urlParams = new URLSearchParams(window.location.search);
    const ticketId = urlParams.get('id');

    if (!token || !ticketId) {
      window.location.href = 'index.html';
    }

    async function loadTicket() {
      const res = await fetch(`${API_BASE}/tickets/${ticketId}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const data = await res.json();
      if (res.ok) {
        const ticket = data.ticket;
        document.getElementById('ticket').innerHTML = `
          <p><strong>ID:</strong> ${ticket.id}</p>
          <p><strong>Title:</strong> ${ticket.title}</p>
          <p><strong>Description:</strong> ${ticket.description || 'No description'}</p>
          <p><strong>Status:</strong> <span class="status ${ticket.status}">${ticket.status.replace('_', ' ')}</span></p>
          <p><strong>Priority:</strong> <span class="priority ${ticket.priority}">${ticket.priority}</span></p>
          <p><strong>SLA Due:</strong> ${new Date(ticket.sla_due_at).toLocaleString()}</p>
          <p><strong>Created:</strong> ${new Date(ticket.created_at).toLocaleString()}</p>
        `;
        const commentsDiv = document.getElementById('comments');
        commentsDiv.innerHTML = '';
        data.comments.forEach(comment => {
          commentsDiv.innerHTML += `<div class="comment">
            <p><strong>User ${comment.author_id}:</strong> ${comment.text}</p>
            <small>${new Date(comment.created_at).toLocaleString()}</small>
          </div>`;
        });
      } else {
        alert(data.error.message);
      }
    }

    document.getElementById('commentForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const text = document.getElementById('commentText').value;
      const res = await fetch(`${API_BASE}/tickets/${ticketId}/comments`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ text })
      });
      const data = await res.json();
      if (res.ok) {
        document.getElementById('commentText').value = '';
        loadTicket();
      } else {
        alert(data.error.message);
      }
    });

    loadTicket();
  </script>
</body>
</html>